# Netty å¸¸è§é¢è¯•é¢˜æ€»ç»“

å¾ˆå¤šå°ä¼™ä¼´æä¸æ¸…æ¥šä¸ºå•¥è¦å­¦ä¹  Netty ï¼Œæ­£å¼ä»Šå¤©è¿™ç¯‡æ–‡ç« å¼€å§‹ä¹‹å‰ï¼Œç®€å•è¯´ä¸€ä¸‹è‡ªå·±çš„çœ‹æ³•ï¼š



+ Netty åŸºäº NIO ï¼ˆNIO æ˜¯ä¸€ç§åŒæ­¥éé˜»å¡çš„ I/O æ¨¡å‹ï¼Œåœ¨ Java 1.4 ä¸­å¼•å…¥äº† NIOï¼‰ï¼Œä½¿ç”¨ Netty å¯ä»¥æå¤§åœ°ç®€åŒ– TCP å’Œ UDP å¥—æ¥å­—æœåŠ¡å™¨ç­‰ç½‘ç»œç¼–ç¨‹ï¼Œå¹¶ä¸”æ€§èƒ½ä»¥åŠå®‰å…¨æ€§ç­‰å¾ˆå¤šæ–¹é¢éƒ½éå¸¸ä¼˜ç§€ã€‚
+ æˆ‘ä»¬å¹³å¸¸ç»å¸¸æ¥è§¦çš„ Dubboã€RocketMQã€Elasticsearchã€gRPCã€Spark ç­‰ç­‰çƒ­é—¨å¼€æºé¡¹ç›®éƒ½ç”¨åˆ°äº† Nettyã€‚
+ å¤§éƒ¨åˆ†å¾®æœåŠ¡æ¡†æ¶åº•å±‚æ¶‰åŠåˆ°ç½‘ç»œé€šä¿¡çš„éƒ¨åˆ†éƒ½æ˜¯åŸºäº Netty æ¥åšçš„ï¼Œæ¯”å¦‚è¯´ Spring Cloud ç”Ÿæ€ç³»ç»Ÿä¸­çš„ç½‘å…³ Spring Cloud Gatewayã€‚



ç®€å•æ€»ç»“ä¸€ä¸‹å’Œ Netty ç›¸å…³é—®é¢˜ã€‚



## BIO,NIO å’Œ AIO æœ‰å•¥åŒºåˆ«ï¼Ÿ


ğŸ‘¨â€ğŸ’»**é¢è¯•å®˜** ï¼šå…ˆæ¥ç®€å•ä»‹ç»ä¸€ä¸‹ BIO,NIO å’Œ AIO 3 è€…çš„åŒºåˆ«å§ï¼



ğŸ™‹ **æˆ‘** ï¼šå¥½çš„ï¼



![90c90b8329fb42a78db86838b74ef184.png](./img/aVTQKA8dnnx7yvVa/1644554459402-ca80695a-53b5-48a4-b54d-b2fa021ebc69-076142.png)



+ **BIO (Blocking I/O):** åŒæ­¥é˜»å¡ I/O æ¨¡å¼ï¼Œæ•°æ®çš„è¯»å–å†™å…¥å¿…é¡»é˜»å¡åœ¨ä¸€ä¸ªçº¿ç¨‹å†…ç­‰å¾…å…¶å®Œæˆã€‚åœ¨å®¢æˆ·ç«¯è¿æ¥æ•°é‡ä¸é«˜çš„æƒ…å†µä¸‹ï¼Œæ˜¯æ²¡é—®é¢˜çš„ã€‚ä½†æ˜¯ï¼Œå½“é¢å¯¹åä¸‡ç”šè‡³ç™¾ä¸‡çº§è¿æ¥çš„æ—¶å€™ï¼Œä¼ ç»Ÿçš„ BIO æ¨¡å‹æ˜¯æ— èƒ½ä¸ºåŠ›çš„ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ç§æ›´é«˜æ•ˆçš„ I/O å¤„ç†æ¨¡å‹æ¥åº”å¯¹æ›´é«˜çš„å¹¶å‘é‡ã€‚
+ **NIO (Non-blocking/New I/O):** NIO æ˜¯ä¸€ç§åŒæ­¥éé˜»å¡çš„ I/O æ¨¡å‹ï¼Œäº Java 1.4 ä¸­å¼•å…¥ï¼Œå¯¹åº” `java.nio`åŒ…ï¼Œæä¾›äº† `Channel` , `Selector`ï¼Œ`Buffer` ç­‰æŠ½è±¡ã€‚NIO ä¸­çš„ N å¯ä»¥ç†è§£ä¸º Non-blockingï¼Œä¸å•çº¯æ˜¯ Newã€‚å®ƒæ”¯æŒé¢å‘ç¼“å†²çš„ï¼ŒåŸºäºé€šé“çš„ I/O æ“ä½œæ–¹æ³•ã€‚ NIO æä¾›äº†ä¸ä¼ ç»Ÿ BIO æ¨¡å‹ä¸­çš„ `Socket` å’Œ `ServerSocket` ç›¸å¯¹åº”çš„ `SocketChannel` å’Œ `ServerSocketChannel` ä¸¤ç§ä¸åŒçš„å¥—æ¥å­—é€šé“å®ç°,ä¸¤ç§é€šé“éƒ½æ”¯æŒé˜»å¡å’Œéé˜»å¡ä¸¤ç§æ¨¡å¼ã€‚å¯¹äºé«˜è´Ÿè½½ã€é«˜å¹¶å‘çš„ï¼ˆç½‘ç»œï¼‰åº”ç”¨ï¼Œåº”ä½¿ç”¨ NIO çš„éé˜»å¡æ¨¡å¼æ¥å¼€å‘
+ **AIO (Asynchronous I/O):** AIO ä¹Ÿå°±æ˜¯ NIO 2ã€‚åœ¨ Java 7 ä¸­å¼•å…¥äº† NIO çš„æ”¹è¿›ç‰ˆ NIO 2,å®ƒæ˜¯å¼‚æ­¥éé˜»å¡çš„ IO æ¨¡å‹ã€‚å¼‚æ­¥ IO æ˜¯åŸºäºäº‹ä»¶å’Œå›è°ƒæœºåˆ¶å®ç°çš„ï¼Œä¹Ÿå°±æ˜¯åº”ç”¨æ“ä½œä¹‹åä¼šç›´æ¥è¿”å›ï¼Œä¸ä¼šå µå¡åœ¨é‚£é‡Œï¼Œå½“åå°å¤„ç†å®Œæˆï¼Œæ“ä½œç³»ç»Ÿä¼šé€šçŸ¥ç›¸åº”çš„çº¿ç¨‹è¿›è¡Œåç»­çš„æ“ä½œã€‚AIO æ˜¯å¼‚æ­¥ IO çš„ç¼©å†™ï¼Œè™½ç„¶ NIO åœ¨ç½‘ç»œæ“ä½œä¸­ï¼Œæä¾›äº†éé˜»å¡çš„æ–¹æ³•ï¼Œä½†æ˜¯ NIO çš„ IO è¡Œä¸ºè¿˜æ˜¯åŒæ­¥çš„ã€‚å¯¹äº NIO æ¥è¯´ï¼Œæˆ‘ä»¬çš„ä¸šåŠ¡çº¿ç¨‹æ˜¯åœ¨ IO æ“ä½œå‡†å¤‡å¥½æ—¶ï¼Œå¾—åˆ°é€šçŸ¥ï¼Œæ¥ç€å°±ç”±è¿™ä¸ªçº¿ç¨‹è‡ªè¡Œè¿›è¡Œ IO æ“ä½œï¼ŒIO æ“ä½œæœ¬èº«æ˜¯åŒæ­¥çš„ã€‚æŸ¥é˜…ç½‘ä¸Šç›¸å…³èµ„æ–™ï¼Œæˆ‘å‘ç°å°±ç›®å‰æ¥è¯´ AIO çš„åº”ç”¨è¿˜ä¸æ˜¯å¾ˆå¹¿æ³›ï¼ŒNetty ä¹‹å‰ä¹Ÿå°è¯•ä½¿ç”¨è¿‡ AIOï¼Œä¸è¿‡åˆæ”¾å¼ƒäº†ã€‚



å…³äº IO æ¨¡å‹æ›´è¯¦ç»†çš„ä»‹ç»ï¼Œä½ å¯ä»¥çœ‹è¿™ç¯‡æ–‡ç« ï¼š[ã€Šå¸¸è§çš„ IO æ¨¡å‹æœ‰å“ªäº›ï¼ŸJava ä¸­çš„ BIOã€NIOã€AIO æœ‰å•¥åŒºåˆ«ï¼Ÿã€‹](https://javaguide.cn/java/io/io-model.html) è¿™ç¯‡æ–‡ç« ã€‚



## Netty æ˜¯ä»€ä¹ˆï¼Ÿ


ğŸ‘¨â€ğŸ’»**é¢è¯•å®˜** ï¼šé‚£ä½ å†æ¥ä»‹ç»ä¸€ä¸‹è‡ªå·±å¯¹ Netty çš„è®¤è¯†å§ï¼å°ä¼™å­ã€‚



ğŸ™‹ **æˆ‘** ï¼šå¥½çš„ï¼é‚£æˆ‘å°±ç®€å•ç”¨ 3 ç‚¹æ¥æ¦‚æ‹¬ä¸€ä¸‹ Netty å§ï¼



1. Netty æ˜¯ä¸€ä¸ª **åŸºäº NIO** çš„ client-server(å®¢æˆ·ç«¯æœåŠ¡å™¨)æ¡†æ¶ï¼Œä½¿ç”¨å®ƒå¯ä»¥å¿«é€Ÿç®€å•åœ°å¼€å‘ç½‘ç»œåº”ç”¨ç¨‹åºã€‚
2. å®ƒæå¤§åœ°ç®€åŒ–å¹¶ä¼˜åŒ–äº† TCP å’Œ UDP å¥—æ¥å­—æœåŠ¡å™¨ç­‰ç½‘ç»œç¼–ç¨‹,å¹¶ä¸”æ€§èƒ½ä»¥åŠå®‰å…¨æ€§ç­‰å¾ˆå¤šæ–¹é¢ç”šè‡³éƒ½è¦æ›´å¥½ã€‚
3. **æ”¯æŒå¤šç§åè®®** å¦‚ FTPï¼ŒSMTPï¼ŒHTTP ä»¥åŠå„ç§äºŒè¿›åˆ¶å’ŒåŸºäºæ–‡æœ¬çš„ä¼ ç»Ÿåè®®ã€‚



ç”¨å®˜æ–¹çš„æ€»ç»“å°±æ˜¯ï¼š**Netty æˆåŠŸåœ°æ‰¾åˆ°äº†ä¸€ç§åœ¨ä¸å¦¥åå¯ç»´æŠ¤æ€§å’Œæ€§èƒ½çš„æƒ…å†µä¸‹å®ç°æ˜“äºå¼€å‘ï¼Œæ€§èƒ½ï¼Œç¨³å®šæ€§å’Œçµæ´»æ€§çš„æ–¹æ³•ã€‚**



_ç½‘ç»œç¼–ç¨‹æˆ‘æ„¿æ„ç§°ä¸­ Netty ä¸ºç‹ ã€‚_



## ä¸ºå•¥ä¸ç›´æ¥ç”¨ NIO å‘¢?


ğŸ‘¨â€ğŸ’»**é¢è¯•å®˜** ï¼šä½ ä¸Šé¢ä¹Ÿè¯´äº† Netty åŸºäº NIOï¼Œé‚£ä¸ºå•¥ä¸ç›´æ¥ç”¨ NIO å‘¢?ã€‚



ä¸ç”¨ NIO ä¸»è¦æ˜¯å› ä¸º NIO çš„ç¼–ç¨‹æ¨¡å‹å¤æ‚è€Œä¸”å­˜åœ¨ä¸€äº› BUGï¼Œå¹¶ä¸”å¯¹ç¼–ç¨‹åŠŸåº•è¦æ±‚æ¯”è¾ƒé«˜ã€‚ä¸‹å›¾å°±æ˜¯ä¸€ä¸ªå…¸å‹çš„ä½¿ç”¨ NIO è¿›è¡Œç¼–ç¨‹çš„æ¡ˆä¾‹ï¼š



![65cda835ebfc0909924fc3cdb88099a7.png](./img/aVTQKA8dnnx7yvVa/1644554459497-8066a91a-e66e-4864-b929-07e453f3f3c4-245592.png)



è€Œä¸”ï¼ŒNIO åœ¨é¢å¯¹æ–­è¿é‡è¿ã€åŒ…ä¸¢å¤±ã€ç²˜åŒ…ç­‰é—®é¢˜æ—¶å¤„ç†è¿‡ç¨‹éå¸¸å¤æ‚ã€‚Netty çš„å‡ºç°æ­£æ˜¯ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œæ›´å¤šå…³äº Netty çš„ç‰¹ç‚¹å¯ä»¥çœ‹ä¸‹é¢çš„å†…å®¹ã€‚



## ä¸ºä»€ä¹ˆè¦ç”¨ Nettyï¼Ÿ


ğŸ‘¨â€ğŸ’»**é¢è¯•å®˜** ï¼šä¸ºä»€ä¹ˆè¦ç”¨ Netty å‘¢ï¼Ÿèƒ½ä¸èƒ½è¯´ä¸€ä¸‹è‡ªå·±çš„çœ‹æ³•ã€‚



ğŸ™‹ **æˆ‘** ï¼šå› ä¸º Netty å…·æœ‰ä¸‹é¢è¿™äº›ä¼˜ç‚¹ï¼Œå¹¶ä¸”ç›¸æ¯”äºç›´æ¥ä½¿ç”¨ JDK è‡ªå¸¦çš„ NIO ç›¸å…³çš„ API æ¥è¯´æ›´åŠ æ˜“ç”¨ã€‚



+ ç»Ÿä¸€çš„ APIï¼Œæ”¯æŒå¤šç§ä¼ è¾“ç±»å‹ï¼Œé˜»å¡å’Œéé˜»å¡çš„ã€‚
+ ç®€å•è€Œå¼ºå¤§çš„çº¿ç¨‹æ¨¡å‹ã€‚
+ è‡ªå¸¦ç¼–è§£ç å™¨è§£å†³ TCP ç²˜åŒ…/æ‹†åŒ…é—®é¢˜ã€‚
+ è‡ªå¸¦å„ç§åè®®æ ˆã€‚
+ çœŸæ­£çš„æ— è¿æ¥æ•°æ®åŒ…å¥—æ¥å­—æ”¯æŒã€‚
+ æ¯”ç›´æ¥ä½¿ç”¨ Java æ ¸å¿ƒ API æœ‰æ›´é«˜çš„ååé‡ã€æ›´ä½çš„å»¶è¿Ÿã€æ›´ä½çš„èµ„æºæ¶ˆè€—å’Œæ›´å°‘çš„å†…å­˜å¤åˆ¶ã€‚
+ å®‰å…¨æ€§ä¸é”™ï¼Œæœ‰å®Œæ•´çš„ SSL/TLS ä»¥åŠ StartTLS æ”¯æŒã€‚
+ ç¤¾åŒºæ´»è·ƒ
+ æˆç†Ÿç¨³å®šï¼Œç»å†äº†å¤§å‹é¡¹ç›®çš„ä½¿ç”¨å’Œè€ƒéªŒï¼Œè€Œä¸”å¾ˆå¤šå¼€æºé¡¹ç›®éƒ½ä½¿ç”¨åˆ°äº† Nettyï¼Œ æ¯”å¦‚æˆ‘ä»¬ç»å¸¸æ¥è§¦çš„ Dubboã€RocketMQ ç­‰ç­‰ã€‚
+ ......



## Netty åº”ç”¨åœºæ™¯äº†è§£ä¹ˆï¼Ÿ


ğŸ‘¨â€ğŸ’»**é¢è¯•å®˜** ï¼šèƒ½ä¸èƒ½é€šä¿—åœ°è¯´ä¸€ä¸‹ä½¿ç”¨ Netty å¯ä»¥åšä»€ä¹ˆäº‹æƒ…ï¼Ÿ



ğŸ™‹ **æˆ‘** ï¼šå‡­å€Ÿè‡ªå·±çš„äº†è§£ï¼Œç®€å•è¯´ä¸€ä¸‹å§ï¼ç†è®ºä¸Šæ¥è¯´ï¼ŒNIO å¯ä»¥åšçš„äº‹æƒ… ï¼Œä½¿ç”¨ Netty éƒ½å¯ä»¥åšå¹¶ä¸”æ›´å¥½ã€‚Netty ä¸»è¦ç”¨æ¥åš**ç½‘ç»œé€šä¿¡** :



1. **ä½œä¸º RPC æ¡†æ¶çš„ç½‘ç»œé€šä¿¡å·¥å…·** ï¼š æˆ‘ä»¬åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œä¸åŒæœåŠ¡èŠ‚ç‚¹ä¹‹é—´ç»å¸¸éœ€è¦ç›¸äº’è°ƒç”¨ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦ RPC æ¡†æ¶äº†ã€‚ä¸åŒæœåŠ¡èŠ‚ç‚¹çš„é€šä¿¡æ˜¯å¦‚ä½•åšçš„å‘¢ï¼Ÿå¯ä»¥ä½¿ç”¨ Netty æ¥åšã€‚æ¯”å¦‚æˆ‘è°ƒç”¨å¦å¤–ä¸€ä¸ªèŠ‚ç‚¹çš„æ–¹æ³•çš„è¯ï¼Œè‡³å°‘æ˜¯è¦è®©å¯¹æ–¹çŸ¥é“æˆ‘è°ƒç”¨çš„æ˜¯å“ªä¸ªç±»ä¸­çš„å“ªä¸ªæ–¹æ³•ä»¥åŠç›¸å…³å‚æ•°å§ï¼
2. **å®ç°ä¸€ä¸ªè‡ªå·±çš„ HTTP æœåŠ¡å™¨** ï¼šé€šè¿‡ Netty æˆ‘ä»¬å¯ä»¥è‡ªå·±å®ç°ä¸€ä¸ªç®€å•çš„ HTTP æœåŠ¡å™¨ï¼Œè¿™ä¸ªå¤§å®¶åº”è¯¥ä¸é™Œç”Ÿã€‚è¯´åˆ° HTTP æœåŠ¡å™¨çš„è¯ï¼Œä½œä¸º Java åç«¯å¼€å‘ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä½¿ç”¨ Tomcat æ¯”è¾ƒå¤šã€‚ä¸€ä¸ªæœ€åŸºæœ¬çš„ HTTP æœåŠ¡å™¨å¯è¦ä»¥å¤„ç†å¸¸è§çš„ HTTP Method çš„è¯·æ±‚ï¼Œæ¯”å¦‚ POST è¯·æ±‚ã€GET è¯·æ±‚ç­‰ç­‰ã€‚
3. **å®ç°ä¸€ä¸ªå³æ—¶é€šè®¯ç³»ç»Ÿ** ï¼š ä½¿ç”¨ Netty æˆ‘ä»¬å¯ä»¥å®ç°ä¸€ä¸ªå¯ä»¥èŠå¤©ç±»ä¼¼å¾®ä¿¡çš„å³æ—¶é€šè®¯ç³»ç»Ÿï¼Œè¿™æ–¹é¢çš„å¼€æºé¡¹ç›®è¿˜è›®å¤šçš„ï¼Œå¯ä»¥è‡ªè¡Œå» Github æ‰¾ä¸€æ‰¾ã€‚
4. **å®ç°æ¶ˆæ¯æ¨é€ç³»ç»Ÿ** ï¼šå¸‚é¢ä¸Šæœ‰å¾ˆå¤šæ¶ˆæ¯æ¨é€ç³»ç»Ÿéƒ½æ˜¯åŸºäº Netty æ¥åšçš„ã€‚
5. ......



## å“ªäº›å¼€æºé¡¹ç›®ç”¨åˆ°äº† Netty?


æˆ‘ä»¬å¹³å¸¸ç»å¸¸æ¥è§¦çš„ Dubboã€RocketMQã€Elasticsearchã€gRPC ç­‰ç­‰éƒ½ç”¨åˆ°äº† Nettyã€‚



å¯ä»¥è¯´å¤§é‡çš„å¼€æºé¡¹ç›®éƒ½ç”¨åˆ°äº† Nettyï¼Œæ‰€ä»¥æŒæ¡ Netty æœ‰åŠ©äºä½ æ›´å¥½çš„ä½¿ç”¨è¿™äº›å¼€æºé¡¹ç›®å¹¶ä¸”è®©ä½ æœ‰èƒ½åŠ›å¯¹å…¶è¿›è¡ŒäºŒæ¬¡å¼€å‘ã€‚



å®é™…ä¸Šè¿˜æœ‰å¾ˆå¤šå¾ˆå¤šä¼˜ç§€çš„é¡¹ç›®ç”¨åˆ°äº† Netty,Netty å®˜æ–¹ä¹Ÿåšäº†ç»Ÿè®¡ï¼Œç»Ÿè®¡ç»“æœåœ¨è¿™é‡Œï¼š[https://netty.io/wiki/related-projects.html](https://netty.io/wiki/related-projects.html) ã€‚



![fcd551063cc03f0b8afb238f6a569fde.png](./img/aVTQKA8dnnx7yvVa/1644554459594-fb62188a-f0f7-4b13-a657-2b4694d8c638-699421.png)



## ä»‹ç»ä¸€ä¸‹ Netty çš„æ ¸å¿ƒç»„ä»¶ï¼Ÿ


ğŸ‘¨â€ğŸ’»**é¢è¯•å®˜** ï¼šNetty æ ¸å¿ƒç»„ä»¶æœ‰å“ªäº›ï¼Ÿåˆ†åˆ«æœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ



ğŸ™‹ **æˆ‘** ï¼šè¡¨é¢ä¸Šï¼Œå˜´ä¸Šå¼€å§‹è¯´èµ· Netty çš„æ ¸å¿ƒç»„ä»¶æœ‰å“ªäº›ï¼Œå®åˆ™ï¼Œå†…å¿ƒå·²ç»å¼€å§‹ mmp äº†ï¼Œæ·±åº¦æ€€ç–‘è¿™é¢è¯•å®˜æ˜¯å­˜å¿ƒææˆ‘å•Šï¼



ç®€å•ä»‹ç» Netty æœ€æ ¸å¿ƒçš„ä¸€äº›ç»„ä»¶ï¼ˆ_å¯¹äºæ¯ä¸€ä¸ªç»„ä»¶è¿™é‡Œä¸è¯¦ç»†ä»‹ç»_ï¼‰ã€‚é€šè¿‡ä¸‹é¢è¿™å¼ å›¾ä½ å¯ä»¥å°†æˆ‘æåˆ°çš„è¿™äº› Netty æ ¸å¿ƒç»„ä»¶ä¸²è”èµ·æ¥ã€‚



![f2f7557a44dbb95963b8ddd6a0960bb9.png](./img/aVTQKA8dnnx7yvVa/1644554459582-da8402e1-7e6d-47cc-8dac-3d5c6a23b466-898667.png)



### Bytebufï¼ˆå­—èŠ‚å®¹å™¨ï¼‰


**ç½‘ç»œé€šä¿¡æœ€ç»ˆéƒ½æ˜¯é€šè¿‡å­—èŠ‚æµè¿›è¡Œä¼ è¾“çš„ã€‚ **`**ByteBuf**`** å°±æ˜¯ Netty æä¾›çš„ä¸€ä¸ªå­—èŠ‚å®¹å™¨ï¼Œå…¶å†…éƒ¨æ˜¯ä¸€ä¸ªå­—èŠ‚æ•°ç»„ã€‚** å½“æˆ‘ä»¬é€šè¿‡ Netty ä¼ è¾“æ•°æ®çš„æ—¶å€™ï¼Œå°±æ˜¯é€šè¿‡ `ByteBuf` è¿›è¡Œçš„ã€‚



æˆ‘ä»¬å¯ä»¥å°† `ByteBuf` çœ‹ä½œæ˜¯ Netty å¯¹ Java NIO æä¾›äº† `ByteBuffer` å­—èŠ‚å®¹å™¨çš„å°è£…å’ŒæŠ½è±¡ã€‚



æœ‰å¾ˆå¤šå°ä¼™ä¼´å¯èƒ½å°±è¦é—®äº† ï¼š **ä¸ºä»€ä¹ˆä¸ç›´æ¥ä½¿ç”¨ Java NIO æä¾›çš„ **`**ByteBuffer**`** å‘¢ï¼Ÿ**



å› ä¸º `ByteBuffer` è¿™ä¸ªç±»ä½¿ç”¨èµ·æ¥è¿‡äºå¤æ‚å’Œç¹çã€‚



### Bootstrap å’Œ ServerBootstrapï¼ˆå¯åŠ¨å¼•å¯¼ç±»ï¼‰


`**Bootstrap**`** æ˜¯å®¢æˆ·ç«¯çš„å¯åŠ¨å¼•å¯¼ç±»/è¾…åŠ©ç±»**ï¼Œå…·ä½“ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š



```java
        EventLoopGroup group = new NioEventLoopGroup();
        try {
            //åˆ›å»ºå®¢æˆ·ç«¯å¯åŠ¨å¼•å¯¼/è¾…åŠ©ç±»ï¼šBootstrap
            Bootstrap b = new Bootstrap();
            //æŒ‡å®šçº¿ç¨‹æ¨¡å‹
            b.group(group).
                    ......
            // å°è¯•å»ºç«‹è¿æ¥
            ChannelFuture f = b.connect(host, port).sync();
            f.channel().closeFuture().sync();
        } finally {
            // ä¼˜é›…å…³é—­ç›¸å…³çº¿ç¨‹ç»„èµ„æº
            group.shutdownGracefully();
        }
```



`**ServerBootstrap**`** æ˜¯æœåŠ¡ç«¯çš„å¯åŠ¨å¼•å¯¼ç±»/è¾…åŠ©ç±»**ï¼Œå…·ä½“ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š



```java
        // 1.bossGroup ç”¨äºæ¥æ”¶è¿æ¥ï¼ŒworkerGroup ç”¨äºå…·ä½“çš„å¤„ç†
        EventLoopGroup bossGroup = new NioEventLoopGroup(1);
        EventLoopGroup workerGroup = new NioEventLoopGroup();
        try {
            //2.åˆ›å»ºæœåŠ¡ç«¯å¯åŠ¨å¼•å¯¼/è¾…åŠ©ç±»ï¼šServerBootstrap
            ServerBootstrap b = new ServerBootstrap();
            //3.ç»™å¼•å¯¼ç±»é…ç½®ä¸¤å¤§çº¿ç¨‹ç»„,ç¡®å®šäº†çº¿ç¨‹æ¨¡å‹
            b.group(bossGroup, workerGroup).
                   ......
            // 6.ç»‘å®šç«¯å£
            ChannelFuture f = b.bind(port).sync();
            // ç­‰å¾…è¿æ¥å…³é—­
            f.channel().closeFuture().sync();
        } finally {
            //7.ä¼˜é›…å…³é—­ç›¸å…³çº¿ç¨‹ç»„èµ„æº
            bossGroup.shutdownGracefully();
            workerGroup.shutdownGracefully();
        }
    }
```



ä»ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼š



1. `Bootstrap` é€šå¸¸ä½¿ç”¨ `connect()` æ–¹æ³•è¿æ¥åˆ°è¿œç¨‹çš„ä¸»æœºå’Œç«¯å£ï¼Œä½œä¸ºä¸€ä¸ª Netty TCP åè®®é€šä¿¡ä¸­çš„å®¢æˆ·ç«¯ã€‚å¦å¤–ï¼Œ`Bootstrap` ä¹Ÿå¯ä»¥é€šè¿‡ `bind()` æ–¹æ³•ç»‘å®šæœ¬åœ°çš„ä¸€ä¸ªç«¯å£ï¼Œä½œä¸º UDP åè®®é€šä¿¡ä¸­çš„ä¸€ç«¯ã€‚
2. `ServerBootstrap`é€šå¸¸ä½¿ç”¨ `bind()` æ–¹æ³•ç»‘å®šæœ¬åœ°çš„ç«¯å£ä¸Šï¼Œç„¶åç­‰å¾…å®¢æˆ·ç«¯çš„è¿æ¥ã€‚
3. `Bootstrap` åªéœ€è¦é…ç½®ä¸€ä¸ªçº¿ç¨‹ç»„â€” `EventLoopGroup` ,è€Œ `ServerBootstrap`éœ€è¦é…ç½®ä¸¤ä¸ªçº¿ç¨‹ç»„â€” `EventLoopGroup` ï¼Œä¸€ä¸ªç”¨äºæ¥æ”¶è¿æ¥ï¼Œä¸€ä¸ªç”¨äºå…·ä½“çš„ IO å¤„ç†ã€‚



### Channelï¼ˆç½‘ç»œæ“ä½œæŠ½è±¡ç±»ï¼‰


`Channel` æ¥å£æ˜¯ Netty å¯¹ç½‘ç»œæ“ä½œæŠ½è±¡ç±»ã€‚é€šè¿‡ `Channel` æˆ‘ä»¬å¯ä»¥è¿›è¡Œ I/O æ“ä½œã€‚



ä¸€æ—¦å®¢æˆ·ç«¯æˆåŠŸè¿æ¥æœåŠ¡ç«¯ï¼Œå°±ä¼šæ–°å»ºä¸€ä¸ª `Channel` åŒè¯¥ç”¨æˆ·ç«¯è¿›è¡Œç»‘å®šï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š



```java
   //  é€šè¿‡ Bootstrap çš„ connect æ–¹æ³•è¿æ¥åˆ°æœåŠ¡ç«¯
   public Channel doConnect(InetSocketAddress inetSocketAddress) {
        CompletableFuture<Channel> completableFuture = new CompletableFuture<>();
        bootstrap.connect(inetSocketAddress).addListener((ChannelFutureListener) future -> {
            if (future.isSuccess()) {
                completableFuture.complete(future.channel());
            } else {
                throw new IllegalStateException();
            }
        });
        return completableFuture.get();
    }
```



æ¯”è¾ƒå¸¸ç”¨çš„`Channel`æ¥å£å®ç°ç±»æ˜¯ ï¼š



+ `NioServerSocketChannel`ï¼ˆæœåŠ¡ç«¯ï¼‰
+ `NioSocketChannel`ï¼ˆå®¢æˆ·ç«¯ï¼‰



è¿™ä¸¤ä¸ª `Channel` å¯ä»¥å’Œ BIO ç¼–ç¨‹æ¨¡å‹ä¸­çš„`ServerSocket`ä»¥åŠ`Socket`ä¸¤ä¸ªæ¦‚å¿µå¯¹åº”ä¸Šã€‚



### EventLoopï¼ˆäº‹ä»¶å¾ªç¯ï¼‰


#### EventLoop ä»‹ç»


è¿™ä¹ˆè¯´å§ï¼`EventLoop`ï¼ˆäº‹ä»¶å¾ªç¯ï¼‰æ¥å£å¯ä»¥è¯´æ˜¯ Netty ä¸­æœ€æ ¸å¿ƒçš„æ¦‚å¿µäº†ï¼



ã€ŠNetty å®æˆ˜ã€‹è¿™æœ¬ä¹¦æ˜¯è¿™æ ·ä»‹ç»å®ƒçš„ï¼š



> `EventLoop` å®šä¹‰äº† Netty çš„æ ¸å¿ƒæŠ½è±¡ï¼Œç”¨äºå¤„ç†è¿æ¥çš„ç”Ÿå‘½å‘¨æœŸä¸­æ‰€å‘ç”Ÿçš„äº‹ä»¶ã€‚
>



æ˜¯ä¸æ˜¯å¾ˆéš¾ç†è§£ï¼Ÿè¯´å®è¯ï¼Œæˆ‘å­¦ä¹  Netty çš„æ—¶å€™çœ‹åˆ°è¿™å¥è¯æ˜¯æ²¡å¤ªèƒ½ç†è§£çš„ã€‚



è¯´ç™½äº†ï¼Œ`**EventLoop**`** çš„ä¸»è¦ä½œç”¨å®é™…å°±æ˜¯è´£ç›‘å¬ç½‘ç»œäº‹ä»¶å¹¶è°ƒç”¨äº‹ä»¶å¤„ç†å™¨è¿›è¡Œç›¸å…³ I/O æ“ä½œï¼ˆè¯»å†™ï¼‰çš„å¤„ç†ã€‚**



#### Channel å’Œ EventLoop çš„å…³ç³»


é‚£ `Channel` å’Œ `EventLoop` ç›´æ¥æœ‰å•¥è”ç³»å‘¢ï¼Ÿ



`**Channel**`** ä¸º Netty ç½‘ç»œæ“ä½œ(è¯»å†™ç­‰æ“ä½œ)æŠ½è±¡ç±»ï¼Œ**`**EventLoop**`** è´Ÿè´£å¤„ç†æ³¨å†Œåˆ°å…¶ä¸Šçš„**`**Channel**`** çš„ I/O æ“ä½œï¼Œä¸¤è€…é…åˆè¿›è¡Œ I/O æ“ä½œã€‚**



#### EventloopGroup å’Œ EventLoop çš„å…³ç³»


`EventLoopGroup` åŒ…å«å¤šä¸ª `EventLoop`ï¼ˆæ¯ä¸€ä¸ª `EventLoop` é€šå¸¸å†…éƒ¨åŒ…å«ä¸€ä¸ªçº¿ç¨‹ï¼‰ï¼Œå®ƒç®¡ç†ç€æ‰€æœ‰çš„ `EventLoop` çš„ç”Ÿå‘½å‘¨æœŸã€‚



å¹¶ä¸”ï¼Œ`**EventLoop**`** å¤„ç†çš„ I/O äº‹ä»¶éƒ½å°†åœ¨å®ƒä¸“æœ‰çš„ **`**Thread**`** ä¸Šè¢«å¤„ç†ï¼Œå³ **`**Thread**`** å’Œ **`**EventLoop**`** å±äº 1 : 1 çš„å…³ç³»ï¼Œä»è€Œä¿è¯çº¿ç¨‹å®‰å…¨ã€‚**



ä¸‹å›¾æ˜¯ Netty **NIO** æ¨¡å‹å¯¹åº”çš„ `EventLoop` æ¨¡å‹ã€‚é€šè¿‡è¿™ä¸ªå›¾åº”è¯¥å¯ä»¥å°†`EventloopGroup`ã€`EventLoop`ã€ `Channel`ä¸‰è€…è”ç³»èµ·æ¥ã€‚



![1679572213010-4d5430af-5506-493a-9741-ec7fcaee5853.png](./img/aVTQKA8dnnx7yvVa/1679572213010-4d5430af-5506-493a-9741-ec7fcaee5853-714535.png)



<font style="color:gray;">https://www.jianshu.com/p/128ddc36e713</font>



### ChannelHandlerï¼ˆæ¶ˆæ¯å¤„ç†å™¨ï¼‰ å’Œ ChannelPipelineï¼ˆChannelHandler å¯¹è±¡é“¾è¡¨ï¼‰


ä¸‹é¢è¿™æ®µä»£ç ä½¿ç”¨è¿‡ Netty çš„å°ä¼™ä¼´åº”è¯¥ä¸ä¼šé™Œç”Ÿï¼Œæˆ‘ä»¬æŒ‡å®šäº†åºåˆ—åŒ–ç¼–è§£ç å™¨ä»¥åŠè‡ªå®šä¹‰çš„ `ChannelHandler` å¤„ç†æ¶ˆæ¯ã€‚



```java
        b.group(eventLoopGroup)
                .handler(new ChannelInitializer<SocketChannel>() {
                    @Override
                    protected void initChannel(SocketChannel ch) {
                        ch.pipeline().addLast(new NettyKryoDecoder(kryoSerializer, RpcResponse.class));
                        ch.pipeline().addLast(new NettyKryoEncoder(kryoSerializer, RpcRequest.class));
                        ch.pipeline().addLast(new KryoClientHandler());
                    }
                });
```



`**ChannelHandler**`** æ˜¯æ¶ˆæ¯çš„å…·ä½“å¤„ç†å™¨ï¼Œä¸»è¦è´Ÿè´£å¤„ç†å®¢æˆ·ç«¯/æœåŠ¡ç«¯æ¥æ”¶å’Œå‘é€çš„æ•°æ®ã€‚**



å½“ `Channel` è¢«åˆ›å»ºæ—¶ï¼Œå®ƒä¼šè¢«è‡ªåŠ¨åœ°åˆ†é…åˆ°å®ƒä¸“å±çš„ `ChannelPipeline`ã€‚ ä¸€ä¸ª`Channel`åŒ…å«ä¸€ä¸ª `ChannelPipeline`ã€‚ `ChannelPipeline` ä¸º `ChannelHandler` çš„é“¾ï¼Œä¸€ä¸ª pipeline ä¸Šå¯ä»¥æœ‰å¤šä¸ª `ChannelHandler`ã€‚



æˆ‘ä»¬å¯ä»¥åœ¨ `ChannelPipeline` ä¸Šé€šè¿‡ `addLast()` æ–¹æ³•æ·»åŠ ä¸€ä¸ªæˆ–è€…å¤šä¸ª`ChannelHandler` ï¼ˆ_ä¸€ä¸ªæ•°æ®æˆ–è€…äº‹ä»¶å¯èƒ½ä¼šè¢«å¤šä¸ª Handler å¤„ç†_ï¼‰ ã€‚å½“ä¸€ä¸ª `ChannelHandler` å¤„ç†å®Œä¹‹åå°±å°†æ•°æ®äº¤ç»™ä¸‹ä¸€ä¸ª `ChannelHandler` ã€‚



å½“ `ChannelHandler` è¢«æ·»åŠ åˆ°çš„ `ChannelPipeline` å®ƒå¾—åˆ°ä¸€ä¸ª `ChannelHandlerContext`ï¼Œå®ƒä»£è¡¨ä¸€ä¸ª `ChannelHandler` å’Œ `ChannelPipeline` ä¹‹é—´çš„â€œç»‘å®šâ€ã€‚ `ChannelPipeline` é€šè¿‡ `ChannelHandlerContext`æ¥é—´æ¥ç®¡ç† `ChannelHandler` ã€‚



![1679572230910-0300cf69-45f1-4cb1-a9d6-060799fa5472.png](./img/aVTQKA8dnnx7yvVa/1679572230910-0300cf69-45f1-4cb1-a9d6-060799fa5472-923563.png)



<font style="color:gray;">https://www.javadoop.com/post/netty-part-4</font>



### ChannelFutureï¼ˆæ“ä½œæ‰§è¡Œç»“æœï¼‰


```java
public interface ChannelFuture extends Future<Void> {
    Channel channel();

    ChannelFuture addListener(GenericFutureListener<? extends Future<? super Void>> var1);
     ......

    ChannelFuture sync() throws InterruptedException;
}
```



Netty ä¸­æ‰€æœ‰çš„ I/O æ“ä½œéƒ½ä¸ºå¼‚æ­¥çš„ï¼Œæˆ‘ä»¬ä¸èƒ½ç«‹åˆ»å¾—åˆ°æ“ä½œæ˜¯å¦æ‰§è¡ŒæˆåŠŸã€‚



ä¸è¿‡ï¼Œä½ å¯ä»¥é€šè¿‡ `ChannelFuture` æ¥å£çš„ `addListener()` æ–¹æ³•æ³¨å†Œä¸€ä¸ª `ChannelFutureListener`ï¼Œå½“æ“ä½œæ‰§è¡ŒæˆåŠŸæˆ–è€…å¤±è´¥æ—¶ï¼Œç›‘å¬å°±ä¼šè‡ªåŠ¨è§¦å‘è¿”å›ç»“æœã€‚



```java
ChannelFuture f = b.connect(host, port).addListener(future -> {
  if (future.isSuccess()) {
    System.out.println("è¿æ¥æˆåŠŸ!");
  } else {
    System.err.println("è¿æ¥å¤±è´¥!");
  }
}).sync();
```



å¹¶ä¸”ï¼Œä½ è¿˜å¯ä»¥é€šè¿‡`ChannelFuture` çš„ `channel()` æ–¹æ³•è·å–è¿æ¥ç›¸å…³è”çš„`Channel` ã€‚



```java
Channel channel = f.channel();
```



å¦å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡ `ChannelFuture` æ¥å£çš„ `sync()`æ–¹æ³•è®©å¼‚æ­¥çš„æ“ä½œå˜æˆåŒæ­¥çš„ã€‚



```java
//bind()æ˜¯å¼‚æ­¥çš„ï¼Œä½†æ˜¯ï¼Œä½ å¯ä»¥é€šè¿‡ sync()æ–¹æ³•å°†å…¶å˜ä¸ºåŒæ­¥ã€‚
ChannelFuture f = b.bind(port).sync();
```



## NioEventLoopGroup é»˜è®¤çš„æ„é€ å‡½æ•°ä¼šèµ·å¤šå°‘çº¿ç¨‹ï¼Ÿ


ğŸ‘¨â€ğŸ’»**é¢è¯•å®˜** ï¼šçœ‹è¿‡ Netty çš„æºç äº†ä¹ˆï¼Ÿ`NioEventLoopGroup` é»˜è®¤çš„æ„é€ å‡½æ•°ä¼šèµ·å¤šå°‘çº¿ç¨‹å‘¢ï¼Ÿ



ğŸ™‹ **æˆ‘** ï¼šå—¯å—¯ï¼çœ‹è¿‡éƒ¨åˆ†ã€‚



å›é¡¾æˆ‘ä»¬åœ¨ä¸Šé¢å†™çš„æœåŠ¡å™¨ç«¯çš„ä»£ç ï¼š



```java
// 1.bossGroup ç”¨äºæ¥æ”¶è¿æ¥ï¼ŒworkerGroup ç”¨äºå…·ä½“çš„å¤„ç†
EventLoopGroup bossGroup = new NioEventLoopGroup(1);
EventLoopGroup workerGroup = new NioEventLoopGroup();
```



ä¸ºäº†ææ¸…æ¥š`NioEventLoopGroup` é»˜è®¤çš„æ„é€ å‡½æ•° åˆ°åº•åˆ›å»ºäº†å¤šå°‘ä¸ªçº¿ç¨‹ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å®ƒçš„æºç ã€‚



```java
    /**
     * æ— å‚æ„é€ å‡½æ•°ã€‚
     * nThreads:0
     */
    public NioEventLoopGroup() {
        //è°ƒç”¨ä¸‹ä¸€ä¸ªæ„é€ æ–¹æ³•
        this(0);
    }

    /**
     * Executorï¼šnull
     */
    public NioEventLoopGroup(int nThreads) {
        //ç»§ç»­è°ƒç”¨ä¸‹ä¸€ä¸ªæ„é€ æ–¹æ³•
        this(nThreads, (Executor) null);
    }

    //ä¸­é—´çœç•¥éƒ¨åˆ†æ„é€ å‡½æ•°

    /**
     * RejectedExecutionHandlerï¼ˆï¼‰ï¼šRejectedExecutionHandlers.reject()
     */
    public NioEventLoopGroup(int nThreads, Executor executor, final SelectorProvider selectorProvider,final SelectStrategyFactory selectStrategyFactory) {
       //å¼€å§‹è°ƒç”¨çˆ¶ç±»çš„æ„é€ å‡½æ•°
        super(nThreads, executor, selectorProvider, selectStrategyFactory, RejectedExecutionHandlers.reject());
    }
```



ä¸€ç›´å‘ä¸‹èµ°ä¸‹å»çš„è¯ï¼Œä½ ä¼šå‘ç°åœ¨ `MultithreadEventLoopGroup` ç±»ä¸­æœ‰ç›¸å…³çš„æŒ‡å®šçº¿ç¨‹æ•°çš„ä»£ç ï¼Œå¦‚ä¸‹ï¼š



```java
    // ä»1ï¼Œç³»ç»Ÿå±æ€§ï¼ŒCPUæ ¸å¿ƒæ•°*2 è¿™ä¸‰ä¸ªå€¼ä¸­å–å‡ºä¸€ä¸ªæœ€å¤§çš„
    //å¯ä»¥å¾—å‡º DEFAULT_EVENT_LOOP_THREADS çš„å€¼ä¸ºCPUæ ¸å¿ƒæ•°*2
    private static final int DEFAULT_EVENT_LOOP_THREADS = Math.max(1, SystemPropertyUtil.getInt("io.netty.eventLoopThreads", NettyRuntime.availableProcessors() * 2));

    // è¢«è°ƒç”¨çš„çˆ¶ç±»æ„é€ å‡½æ•°ï¼ŒNioEventLoopGroup é»˜è®¤çš„æ„é€ å‡½æ•°ä¼šèµ·å¤šå°‘çº¿ç¨‹çš„ç§˜å¯†æ‰€åœ¨
    // å½“æŒ‡å®šçš„çº¿ç¨‹æ•°nThreadsä¸º0æ—¶ï¼Œä½¿ç”¨é»˜è®¤çš„çº¿ç¨‹æ•°DEFAULT_EVENT_LOOP_THREADS
    protected MultithreadEventLoopGroup(int nThreads, ThreadFactory threadFactory, Object... args) {
        super(nThreads == 0 ? DEFAULT_EVENT_LOOP_THREADS : nThreads, threadFactory, args);
    }
```



ç»¼ä¸Šï¼Œæˆ‘ä»¬å‘ç° `NioEventLoopGroup` é»˜è®¤çš„æ„é€ å‡½æ•°å®é™…ä¼šèµ·çš„çº¿ç¨‹æ•°ä¸º `**CPUæ ¸å¿ƒæ•°*2**`ã€‚



å¦å¤–ï¼Œå¦‚æœä½ ç»§ç»­æ·±å…¥ä¸‹å»çœ‹æ„é€ å‡½æ•°çš„è¯ï¼Œä½ ä¼šå‘ç°æ¯ä¸ª`NioEventLoopGroup`å¯¹è±¡å†…éƒ¨éƒ½ä¼šåˆ†é…ä¸€ç»„`NioEventLoop`ï¼Œå…¶å¤§å°æ˜¯ `nThreads`, è¿™æ ·å°±æ„æˆäº†ä¸€ä¸ªçº¿ç¨‹æ± ï¼Œ ä¸€ä¸ª`NIOEventLoop` å’Œä¸€ä¸ªçº¿ç¨‹ç›¸å¯¹åº”ï¼Œè¿™å’Œæˆ‘ä»¬ä¸Šé¢è¯´çš„ `EventloopGroup` å’Œ `EventLoop`å…³ç³»è¿™éƒ¨åˆ†å†…å®¹ç›¸å¯¹åº”ã€‚



## Reactor çº¿ç¨‹æ¨¡å‹


ğŸ‘¨â€ğŸ’»**é¢è¯•å®˜** ï¼šå¤§éƒ¨åˆ†ç½‘ç»œæ¡†æ¶éƒ½æ˜¯åŸºäº Reactor æ¨¡å¼è®¾è®¡å¼€å‘çš„ã€‚ä½ å…ˆèŠèŠ Reactor çº¿ç¨‹æ¨¡å‹å§ï¼



ğŸ™‹ **æˆ‘** ï¼šå¥½çš„å‘€ï¼



**Reactor æ˜¯ä¸€ç§ç»å…¸çš„çº¿ç¨‹æ¨¡å‹ï¼ŒReactor æ¨¡å¼åŸºäºäº‹ä»¶é©±åŠ¨ï¼Œç‰¹åˆ«é€‚åˆå¤„ç†æµ·é‡çš„ I/O äº‹ä»¶ã€‚**



Reactor çº¿ç¨‹æ¨¡å‹åˆ†ä¸ºå•çº¿ç¨‹æ¨¡å‹ã€å¤šçº¿ç¨‹æ¨¡å‹ä»¥åŠä¸»ä»å¤šçº¿ç¨‹æ¨¡å‹ã€‚



> ä»¥ä¸‹å›¾ç‰‡æ¥æºäºç½‘ç»œï¼ŒåŸå‡ºå¤„ä¸æ˜ï¼Œå¦‚æœ‰ä¾µæƒè¯·è”ç³»æˆ‘ã€‚
>



### å•çº¿ç¨‹ Reactor


æ‰€æœ‰çš„ IO æ“ä½œéƒ½ç”±åŒä¸€ä¸ª NIO çº¿ç¨‹å¤„ç†ã€‚



![e5493f74f5ed16c462c36654170e16ae.png](./img/aVTQKA8dnnx7yvVa/1644554459486-e516ba9e-3bfb-43e2-aa50-115fd4bcc696-537635.png)



**å•çº¿ç¨‹ Reactor çš„ä¼˜ç‚¹æ˜¯å¯¹ç³»ç»Ÿèµ„æºæ¶ˆè€—ç‰¹åˆ«å°ï¼Œä½†æ˜¯ï¼Œæ²¡åŠæ³•æ”¯æ’‘å¤§é‡è¯·æ±‚çš„åº”ç”¨åœºæ™¯å¹¶ä¸”å¤„ç†è¯·æ±‚çš„æ—¶é—´å¯èƒ½éå¸¸æ…¢ï¼Œæ¯•ç«Ÿåªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨å·¥ä½œå˜›ï¼æ‰€ä»¥ï¼Œä¸€èˆ¬å®é™…é¡¹ç›®ä¸­ä¸ä¼šä½¿ç”¨å•çº¿ç¨‹ Reactor ã€‚**



ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œæ¼”è¿›å‡ºäº† Reactor å¤šçº¿ç¨‹æ¨¡å‹ã€‚



### å¤šçº¿ç¨‹ Reactor


ä¸€ä¸ªçº¿ç¨‹è´Ÿè´£æ¥å—è¯·æ±‚,ä¸€ç»„ NIO çº¿ç¨‹å¤„ç† IO æ“ä½œã€‚



![0e694ecd1399d78b8983f22fc0e2341e.png](./img/aVTQKA8dnnx7yvVa/1644554459729-48589400-e242-400d-abab-99c5c2767149-880983.png)



**å¤§éƒ¨åˆ†åœºæ™¯ä¸‹å¤šçº¿ç¨‹ Reactor æ¨¡å‹æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œä½†æ˜¯åœ¨ä¸€äº›å¹¶å‘è¿æ¥æ•°æ¯”è¾ƒå¤šï¼ˆå¦‚ç™¾ä¸‡å¹¶å‘ï¼‰çš„åœºæ™¯ä¸‹ï¼Œä¸€ä¸ªçº¿ç¨‹è´Ÿè´£æ¥å—å®¢æˆ·ç«¯è¯·æ±‚å°±å­˜åœ¨æ€§èƒ½é—®é¢˜äº†ã€‚**



ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œæ¼”è¿›å‡ºäº†ä¸»ä»å¤šçº¿ç¨‹ Reactor æ¨¡å‹ã€‚



### ä¸»ä»å¤šçº¿ç¨‹ Reactor


ä¸€ç»„ NIO çº¿ç¨‹è´Ÿè´£æ¥å—è¯·æ±‚ï¼Œä¸€ç»„ NIO çº¿ç¨‹å¤„ç† IO æ“ä½œã€‚



![4059d7d2e2d73b876774ce7e55cc819c.png](./img/aVTQKA8dnnx7yvVa/1644554459560-15fbec70-5dd8-47ab-b37b-ab8e24770c71-021427.png)



## Netty çº¿ç¨‹æ¨¡å‹äº†è§£ä¹ˆï¼Ÿ


ğŸ‘¨â€ğŸ’»**é¢è¯•å®˜** ï¼šè¯´ä¸€ä¸‹ Netty çº¿ç¨‹æ¨¡å‹å§ï¼



ğŸ™‹ **æˆ‘** ï¼šå¤§éƒ¨åˆ†ç½‘ç»œæ¡†æ¶éƒ½æ˜¯åŸºäº Reactor æ¨¡å¼è®¾è®¡å¼€å‘çš„ã€‚



> Reactor æ¨¡å¼åŸºäºäº‹ä»¶é©±åŠ¨ï¼Œé‡‡ç”¨å¤šè·¯å¤ç”¨å°†äº‹ä»¶åˆ†å‘ç»™ç›¸åº”çš„ Handler å¤„ç†ï¼Œéå¸¸é€‚åˆå¤„ç†æµ·é‡ IO çš„åœºæ™¯ã€‚
>



åœ¨ Netty ä¸»è¦é  `NioEventLoopGroup` çº¿ç¨‹æ± æ¥å®ç°å…·ä½“çš„çº¿ç¨‹æ¨¡å‹çš„ ã€‚



æˆ‘ä»¬å®ç°æœåŠ¡ç«¯çš„æ—¶å€™ï¼Œä¸€èˆ¬ä¼šåˆå§‹åŒ–ä¸¤ä¸ªçº¿ç¨‹ç»„ï¼š



1. `**bossGroup**` :æ¥æ”¶è¿æ¥ã€‚
2. `**workerGroup**` ï¼šè´Ÿè´£å…·ä½“çš„å¤„ç†ï¼Œäº¤ç”±å¯¹åº”çš„ Handler å¤„ç†ã€‚



ä¸‹é¢æˆ‘ä»¬æ¥è¯¦ç»†çœ‹ä¸€ä¸‹ Netty ä¸­çš„çº¿ç¨‹æ¨¡å‹å§ï¼



### å•çº¿ç¨‹æ¨¡å‹


ä¸€ä¸ªçº¿ç¨‹å•ç‹¬å¤„ç†å®¢æˆ·ç«¯è¿æ¥ä»¥åŠ I/O è¯»å†™ï¼Œæ¶‰åŠåˆ° `accept`ã€`read`ã€`decode`ã€`process`ã€`encode`ã€`send` ç­‰äº‹ä»¶ã€‚



å¯¹äºé«˜è´Ÿè½½ã€é«˜å¹¶å‘ï¼Œå¹¶ä¸”å¯¹æ€§èƒ½è¦æ±‚æ¯”è¾ƒé«˜çš„åœºæ™¯ä¸é€‚ç”¨ã€‚



å¯¹åº”åˆ° Netty ä»£ç æ˜¯ä¸‹é¢è¿™æ ·çš„ï¼š



> ä½¿ç”¨ `NioEventLoopGroup` ç±»çš„æ— å‚æ„é€ å‡½æ•°è®¾ç½®çº¿ç¨‹æ•°é‡çš„é»˜è®¤å€¼å°±æ˜¯ **CPU æ ¸å¿ƒæ•° *2** ã€‚
>



```java
  //1.eventGroupæ—¢ç”¨äºå¤„ç†å®¢æˆ·ç«¯è¿æ¥ï¼Œåˆè´Ÿè´£å…·ä½“çš„å¤„ç†ã€‚
  EventLoopGroup eventGroup = new NioEventLoopGroup(1);
  //2.åˆ›å»ºæœåŠ¡ç«¯å¯åŠ¨å¼•å¯¼/è¾…åŠ©ç±»ï¼šServerBootstrap
  ServerBootstrap b = new ServerBootstrap();
            boobtstrap.group(eventGroup, eventGroup)
            //......
```



### å¤šçº¿ç¨‹æ¨¡å‹


ä¸€ä¸ª Acceptor çº¿ç¨‹åªè´Ÿè´£ç›‘å¬å®¢æˆ·ç«¯çš„è¿æ¥ï¼Œä¸€ä¸ª NIO çº¿ç¨‹æ± è´Ÿè´£å¤„ç† I/O è¯»å†™ã€‚



å¤šçº¿ç¨‹æ¨¡å‹æ»¡è¶³ç»å¤§éƒ¨åˆ†åº”ç”¨åœºæ™¯ï¼Œå¹¶å‘è¿æ¥é‡ä¸å¤§çš„æ—¶å€™æ²¡å•¥é—®é¢˜ï¼Œä½†æ˜¯é‡åˆ°å¹¶å‘è¿æ¥å¤§çš„æ—¶å€™å°±å¯èƒ½ä¼šå‡ºç°é—®é¢˜ï¼Œæˆä¸ºæ€§èƒ½ç“¶é¢ˆã€‚



å¯¹åº”åˆ° Netty ä»£ç æ˜¯ä¸‹é¢è¿™æ ·çš„ï¼š



```java
// 1.bossGroup ç”¨äºæ¥æ”¶è¿æ¥ï¼ŒworkerGroup ç”¨äºå…·ä½“çš„å¤„ç†
EventLoopGroup bossGroup = new NioEventLoopGroup(1);
EventLoopGroup workerGroup = new NioEventLoopGroup();
try {
  //2.åˆ›å»ºæœåŠ¡ç«¯å¯åŠ¨å¼•å¯¼/è¾…åŠ©ç±»ï¼šServerBootstrap
  ServerBootstrap b = new ServerBootstrap();
  //3.ç»™å¼•å¯¼ç±»é…ç½®ä¸¤å¤§çº¿ç¨‹ç»„,ç¡®å®šäº†çº¿ç¨‹æ¨¡å‹
  b.group(bossGroup, workerGroup)
    //......
```



![a28d325d2ea83d33ef668bdfb65ea3dd.png](./img/aVTQKA8dnnx7yvVa/1644554459673-d142a1cd-45b5-446c-96fd-9627c4f7741c-376355.png)



### ä¸»ä»å¤šçº¿ç¨‹æ¨¡å‹


ä»ä¸€ä¸ª ä¸»çº¿ç¨‹ NIO çº¿ç¨‹æ± ä¸­é€‰æ‹©ä¸€ä¸ªçº¿ç¨‹ä½œä¸º Acceptor çº¿ç¨‹ï¼Œç»‘å®šç›‘å¬ç«¯å£ï¼Œæ¥æ”¶å®¢æˆ·ç«¯è¿æ¥çš„è¿æ¥ï¼Œå…¶ä»–çº¿ç¨‹è´Ÿè´£åç»­çš„æ¥å…¥è®¤è¯ç­‰å·¥ä½œã€‚è¿æ¥å»ºç«‹å®Œæˆåï¼ŒSub NIO çº¿ç¨‹æ± è´Ÿè´£å…·ä½“å¤„ç† I/O è¯»å†™ã€‚



å¦‚æœå¤šçº¿ç¨‹æ¨¡å‹æ— æ³•æ»¡è¶³ä½ çš„éœ€æ±‚çš„æ—¶å€™ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ä¸»ä»å¤šçº¿ç¨‹æ¨¡å‹ ã€‚



```java
// 1.bossGroup ç”¨äºæ¥æ”¶è¿æ¥ï¼ŒworkerGroup ç”¨äºå…·ä½“çš„å¤„ç†
EventLoopGroup bossGroup = new NioEventLoopGroup();
EventLoopGroup workerGroup = new NioEventLoopGroup();
try {
  //2.åˆ›å»ºæœåŠ¡ç«¯å¯åŠ¨å¼•å¯¼/è¾…åŠ©ç±»ï¼šServerBootstrap
  ServerBootstrap b = new ServerBootstrap();
  //3.ç»™å¼•å¯¼ç±»é…ç½®ä¸¤å¤§çº¿ç¨‹ç»„,ç¡®å®šäº†çº¿ç¨‹æ¨¡å‹
  b.group(bossGroup, workerGroup)
    //......
```



![e1cb7166e191b3af46c630862c905cba.png](./img/aVTQKA8dnnx7yvVa/1644554459520-a1b38b45-dc8b-4af7-9053-92df542f2179-556593.png)



## Netty æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯çš„å¯åŠ¨è¿‡ç¨‹äº†è§£ä¹ˆï¼Ÿ


### æœåŠ¡ç«¯


```java
// 1.bossGroup ç”¨äºæ¥æ”¶è¿æ¥ï¼ŒworkerGroup ç”¨äºå…·ä½“çš„å¤„ç†
EventLoopGroup bossGroup = new NioEventLoopGroup(1);
EventLoopGroup workerGroup = new NioEventLoopGroup();
try {
    //2.åˆ›å»ºæœåŠ¡ç«¯å¯åŠ¨å¼•å¯¼/è¾…åŠ©ç±»ï¼šServerBootstrap
    ServerBootstrap b = new ServerBootstrap();
    //3.ç»™å¼•å¯¼ç±»é…ç½®ä¸¤å¤§çº¿ç¨‹ç»„,ç¡®å®šäº†çº¿ç¨‹æ¨¡å‹
    b.group(bossGroup, workerGroup)
            // (éå¿…å¤‡)æ‰“å°æ—¥å¿—
            .handler(new LoggingHandler(LogLevel.INFO))
            // 4.æŒ‡å®š IO æ¨¡å‹
            .channel(NioServerSocketChannel.class)
            .childHandler(new ChannelInitializer<SocketChannel>() {
                @Override
                public void initChannel(SocketChannel ch) {
                    ChannelPipeline p = ch.pipeline();
                    //5.å¯ä»¥è‡ªå®šä¹‰å®¢æˆ·ç«¯æ¶ˆæ¯çš„ä¸šåŠ¡å¤„ç†é€»è¾‘
                    p.addLast(new HelloServerHandler());
                }
            });
    // 6.ç»‘å®šç«¯å£,è°ƒç”¨ sync æ–¹æ³•é˜»å¡çŸ¥é“ç»‘å®šå®Œæˆ
    ChannelFuture f = b.bind(port).sync();
    // 7.é˜»å¡ç­‰å¾…ç›´åˆ°æœåŠ¡å™¨Channelå…³é—­(closeFuture()æ–¹æ³•è·å–Channel çš„CloseFutureå¯¹è±¡,ç„¶åè°ƒç”¨sync()æ–¹æ³•)
    f.channel().closeFuture().sync();
} finally {
    //8.ä¼˜é›…å…³é—­ç›¸å…³çº¿ç¨‹ç»„èµ„æº
    bossGroup.shutdownGracefully();
    workerGroup.shutdownGracefully();
}
```



ç®€å•è§£æä¸€ä¸‹æœåŠ¡ç«¯çš„åˆ›å»ºè¿‡ç¨‹å…·ä½“æ˜¯æ€æ ·çš„ï¼š



1ã€é¦–å…ˆä½ åˆ›å»ºäº†ä¸¤ä¸ª `NioEventLoopGroup` å¯¹è±¡å®ä¾‹ï¼š`bossGroup` å’Œ `workerGroup`ã€‚



+ `bossGroup` : ç”¨äºå¤„ç†å®¢æˆ·ç«¯çš„ TCP è¿æ¥è¯·æ±‚ã€‚
+ `workerGroup` ï¼š è´Ÿè´£æ¯ä¸€æ¡è¿æ¥çš„å…·ä½“è¯»å†™æ•°æ®çš„å¤„ç†é€»è¾‘ï¼ŒçœŸæ­£è´Ÿè´£ I/O è¯»å†™æ“ä½œï¼Œäº¤ç”±å¯¹åº”çš„ `Handler` å¤„ç†ã€‚



ä¸¾ä¸ªä¾‹å­ï¼šæˆ‘ä»¬æŠŠå…¬å¸çš„è€æ¿å½“åš `bossGroup`ï¼Œå‘˜å·¥å½“åš `workerGroup`ï¼Œ`bossGroup` åœ¨å¤–é¢æ¥å®Œæ´»ä¹‹åï¼Œæ‰”ç»™ `workerGroup` å»å¤„ç†ã€‚ä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬ä¼šæŒ‡å®š `bossGroup` çš„ çº¿ç¨‹æ•°ä¸º 1ï¼ˆå¹¶å‘è¿æ¥é‡ä¸å¤§çš„æ—¶å€™ï¼‰ ï¼Œ`workGroup` çš„çº¿ç¨‹æ•°é‡ä¸º **CPU æ ¸å¿ƒæ•° *2** ã€‚å¦å¤–ï¼Œæ ¹æ®æºç æ¥çœ‹ï¼Œä½¿ç”¨ `NioEventLoopGroup` ç±»çš„æ— å‚æ„é€ å‡½æ•°è®¾ç½®çº¿ç¨‹æ•°é‡çš„é»˜è®¤å€¼å°±æ˜¯ **CPU æ ¸å¿ƒæ•° *2** ã€‚



2ã€æ¥ä¸‹æ¥ æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªæœåŠ¡ç«¯å¯åŠ¨å¼•å¯¼/è¾…åŠ©ç±»ï¼š `ServerBootstrap`ï¼Œè¿™ä¸ªç±»å°†å¼•å¯¼æˆ‘ä»¬è¿›è¡ŒæœåŠ¡ç«¯çš„å¯åŠ¨å·¥ä½œã€‚



3ã€é€šè¿‡ `group()` æ–¹æ³•ç»™å¼•å¯¼ç±» `ServerBootstrap` é…ç½®ä¸¤å¤§çº¿ç¨‹ç»„ï¼Œç¡®å®šäº†çº¿ç¨‹æ¨¡å‹ã€‚



é€šè¿‡ä¸‹é¢çš„ä»£ç ï¼Œæˆ‘ä»¬å®é™…é…ç½®çš„æ˜¯å¤šçº¿ç¨‹æ¨¡å‹ï¼Œè¿™ä¸ªåœ¨ä¸Šé¢æåˆ°è¿‡ã€‚



```java
EventLoopGroup bossGroup = new NioEventLoopGroup(1);
EventLoopGroup workerGroup = new NioEventLoopGroup();
```



4ã€é€šè¿‡`channel()`æ–¹æ³•ç»™å¼•å¯¼ç±» `ServerBootstrap`æŒ‡å®šäº† IO æ¨¡å‹ä¸º`NIO`



+  `NioServerSocketChannel` ï¼šæŒ‡å®šæœåŠ¡ç«¯çš„ IO æ¨¡å‹ä¸º NIOï¼Œä¸ BIO ç¼–ç¨‹æ¨¡å‹ä¸­çš„`ServerSocket`å¯¹åº” 
+  `NioSocketChannel` : æŒ‡å®šå®¢æˆ·ç«¯çš„ IO æ¨¡å‹ä¸º NIOï¼Œ ä¸ BIO ç¼–ç¨‹æ¨¡å‹ä¸­çš„`Socket`å¯¹åº” 



5ã€é€šè¿‡ `childHandler()`æ–¹æ³•ç»™å¼•å¯¼ç±»åˆ›å»ºä¸€ä¸ª`ChannelInitializer` ï¼Œç„¶åæŒ‡å®šäº†æœåŠ¡ç«¯æ¶ˆæ¯çš„ä¸šåŠ¡å¤„ç†é€»è¾‘ `HelloServerHandler` å¯¹è±¡ã€‚



6ã€è°ƒç”¨ `ServerBootstrap` ç±»çš„ `bind()`æ–¹æ³•ç»‘å®šç«¯å£ã€‚



### å®¢æˆ·ç«¯


```java
    //1.åˆ›å»ºä¸€ä¸ª NioEventLoopGroup å¯¹è±¡å®ä¾‹
    EventLoopGroup group = new NioEventLoopGroup();
    try {
        //2.åˆ›å»ºå®¢æˆ·ç«¯å¯åŠ¨å¼•å¯¼/è¾…åŠ©ç±»ï¼šBootstrap
        Bootstrap b = new Bootstrap();
        //3.æŒ‡å®šçº¿ç¨‹ç»„
        b.group(group)
                //4.æŒ‡å®š IO æ¨¡å‹
                .channel(NioSocketChannel.class)
                .handler(new ChannelInitializer<SocketChannel>() {
                    @Override
                    public void initChannel(SocketChannel ch) throws Exception {
                        ChannelPipeline p = ch.pipeline();
                        // 5.è¿™é‡Œå¯ä»¥è‡ªå®šä¹‰æ¶ˆæ¯çš„ä¸šåŠ¡å¤„ç†é€»è¾‘
                        p.addLast(new HelloClientHandler(message));
                    }
                });
        // 6.å°è¯•å»ºç«‹è¿æ¥
        ChannelFuture f = b.connect(host, port).sync();
        // 7.ç­‰å¾…è¿æ¥å…³é—­ï¼ˆé˜»å¡ï¼Œç›´åˆ°Channelå…³é—­ï¼‰
        f.channel().closeFuture().sync();
    } finally {
        group.shutdownGracefully();
    }
```



ç»§ç»­åˆ†æä¸€ä¸‹å®¢æˆ·ç«¯çš„åˆ›å»ºæµç¨‹ï¼š



1ã€åˆ›å»ºä¸€ä¸ª `NioEventLoopGroup` å¯¹è±¡å®ä¾‹



2ã€åˆ›å»ºå®¢æˆ·ç«¯å¯åŠ¨çš„å¼•å¯¼ç±»æ˜¯ `Bootstrap`



3ã€é€šè¿‡ `group()` æ–¹æ³•ç»™å¼•å¯¼ç±» `Bootstrap` é…ç½®ä¸€ä¸ªçº¿ç¨‹ç»„



4ã€é€šè¿‡`channel()`æ–¹æ³•ç»™å¼•å¯¼ç±» `Bootstrap`æŒ‡å®šäº† IO æ¨¡å‹ä¸º`NIO`



5ã€é€šè¿‡ `handler()`æ–¹æ³•ç»™å¼•å¯¼ç±»åˆ›å»ºä¸€ä¸ª`ChannelInitializer` ï¼Œç„¶åæŒ‡å®šäº†å®¢æˆ·ç«¯æ¶ˆæ¯çš„ä¸šåŠ¡å¤„ç†é€»è¾‘ `HelloClientHandler` å¯¹è±¡



6ã€è°ƒç”¨ `Bootstrap` ç±»çš„ `connect()`æ–¹æ³•è¿›è¡Œè¿æ¥ï¼Œè¿™ä¸ªæ–¹æ³•éœ€è¦æŒ‡å®šä¸¤ä¸ªå‚æ•°ï¼š



+ `inetHost` : ip åœ°å€
+ `inetPort` : ç«¯å£å·



```java
    public ChannelFuture connect(String inetHost, int inetPort) {
        return this.connect(InetSocketAddress.createUnresolved(inetHost, inetPort));
    }

    public ChannelFuture connect(SocketAddress remoteAddress) {
        ObjectUtil.checkNotNull(remoteAddress, "remoteAddress");
        this.validate();
        return this.doResolveAndConnect(remoteAddress, this.config.localAddress());
    }
```



`connect` æ–¹æ³•è¿”å›çš„æ˜¯ä¸€ä¸ª `Future` ç±»å‹çš„å¯¹è±¡



```java
public interface ChannelFuture extends Future<Void> {
  ......
}
```



ä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªæ–¹æ˜¯å¼‚æ­¥çš„ï¼Œæˆ‘ä»¬é€šè¿‡ `addListener` æ–¹æ³•å¯ä»¥ç›‘å¬åˆ°è¿æ¥æ˜¯å¦æˆåŠŸï¼Œè¿›è€Œæ‰“å°å‡ºè¿æ¥ä¿¡æ¯ã€‚å…·ä½“åšæ³•å¾ˆç®€å•ï¼Œåªéœ€è¦å¯¹ä»£ç è¿›è¡Œä»¥ä¸‹æ”¹åŠ¨ï¼š



```java
ChannelFuture f = b.connect(host, port).addListener(future -> {
  if (future.isSuccess()) {
    System.out.println("è¿æ¥æˆåŠŸ!");
  } else {
    System.err.println("è¿æ¥å¤±è´¥!");
  }
}).sync();
```

## ä»€ä¹ˆæ˜¯ TCP ç²˜åŒ…/æ‹†åŒ…?æœ‰ä»€ä¹ˆè§£å†³åŠæ³•å‘¢ï¼Ÿ


ğŸ‘¨â€ğŸ’»**é¢è¯•å®˜** ï¼šä»€ä¹ˆæ˜¯ TCP ç²˜åŒ…/æ‹†åŒ…?



ğŸ™‹ **æˆ‘** ï¼šTCP ç²˜åŒ…/æ‹†åŒ… å°±æ˜¯ä½ åŸºäº TCP å‘é€æ•°æ®çš„æ—¶å€™ï¼Œå‡ºç°äº†å¤šä¸ªå­—ç¬¦ä¸²â€œç²˜â€åœ¨äº†ä¸€èµ·æˆ–è€…ä¸€ä¸ªå­—ç¬¦ä¸²è¢«â€œæ‹†â€å¼€çš„é—®é¢˜ã€‚æ¯”å¦‚ä½ å¤šæ¬¡å‘é€ï¼šâ€œä½ å¥½,ä½ çœŸå¸…å•Šï¼å“¥å“¥ï¼â€ï¼Œä½†æ˜¯å®¢æˆ·ç«¯æ¥æ”¶åˆ°çš„å¯èƒ½æ˜¯ä¸‹é¢è¿™æ ·çš„ï¼š



![50c32107b2da3a880909129ada10953b.png](./img/aVTQKA8dnnx7yvVa/1644554459709-54e900aa-bf51-41dd-8673-c21eae472f2f-113837.png)



ğŸ‘¨â€ğŸ’»**é¢è¯•å®˜** ï¼šé‚£æœ‰ä»€ä¹ˆè§£å†³åŠæ³•å‘¢?



ğŸ™‹ **æˆ‘** ï¼š



**1.ä½¿ç”¨ Netty è‡ªå¸¦çš„è§£ç å™¨**



+ `**LineBasedFrameDecoder**` : å‘é€ç«¯å‘é€æ•°æ®åŒ…çš„æ—¶å€™ï¼Œæ¯ä¸ªæ•°æ®åŒ…ä¹‹é—´ä»¥æ¢è¡Œç¬¦ä½œä¸ºåˆ†éš”ï¼Œ`LineBasedFrameDecoder` çš„å·¥ä½œåŸç†æ˜¯å®ƒä¾æ¬¡éå† `ByteBuf` ä¸­çš„å¯è¯»å­—èŠ‚ï¼Œåˆ¤æ–­æ˜¯å¦æœ‰æ¢è¡Œç¬¦ï¼Œç„¶åè¿›è¡Œç›¸åº”çš„æˆªå–ã€‚
+ `**DelimiterBasedFrameDecoder**` : å¯ä»¥è‡ªå®šä¹‰åˆ†éš”ç¬¦è§£ç å™¨ï¼Œå®é™…ä¸Šæ˜¯ä¸€ç§ç‰¹æ®Šçš„ `DelimiterBasedFrameDecoder` è§£ç å™¨ã€‚
+ `**FixedLengthFrameDecoder**`: å›ºå®šé•¿åº¦è§£ç å™¨ï¼Œå®ƒèƒ½å¤ŸæŒ‰ç…§æŒ‡å®šçš„é•¿åº¦å¯¹æ¶ˆæ¯è¿›è¡Œç›¸åº”çš„æ‹†åŒ…ã€‚å¦‚æœä¸å¤ŸæŒ‡å®šçš„é•¿åº¦ï¼Œåˆ™ç©ºæ ¼è¡¥å…¨
+ `**LengthFieldBasedFrameDecoder**`ï¼šé•¿åº¦åŸŸè§£ç å™¨ï¼Œå®ƒèƒ½å¤Ÿæ ¹æ®å‘é€çš„æ•°æ®ä¸­æ¶ˆæ¯é•¿åº¦ç›¸å…³å‚æ•°ï¼ˆæ¯”å¦‚é•¿åº¦åŸŸåç§»é‡ `lengthFieldOffset`ï¼‰æ¥è¿›è¡Œæ‹†åŒ…ã€‚



**2.è‡ªå®šä¹‰åºåˆ—åŒ–ç¼–è§£ç å™¨**



åœ¨ Java ä¸­è‡ªå¸¦çš„æœ‰å®ç° `Serializable` æ¥å£æ¥å®ç°åºåˆ—åŒ–ï¼Œä½†ç”±äºå®ƒæ€§èƒ½ã€å®‰å…¨æ€§ç­‰åŸå› ä¸€èˆ¬æƒ…å†µä¸‹æ˜¯ä¸ä¼šè¢«ä½¿ç”¨åˆ°çš„ã€‚



é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨ Protostuffã€Hessian2ã€json åºåˆ—æ–¹å¼æ¯”è¾ƒå¤šï¼Œå¦å¤–è¿˜æœ‰ä¸€äº›åºåˆ—åŒ–æ€§èƒ½éå¸¸å¥½çš„åºåˆ—åŒ–æ–¹å¼ä¹Ÿæ˜¯å¾ˆå¥½çš„é€‰æ‹©ï¼š



+ ä¸“é—¨é’ˆå¯¹ Java è¯­è¨€çš„ï¼šKryoï¼ŒFST ç­‰ç­‰
+ è·¨è¯­è¨€çš„ï¼šProtostuffï¼ˆåŸºäº protobuf å‘å±•è€Œæ¥ï¼‰ï¼ŒProtoBufï¼ŒThriftï¼ŒAvroï¼ŒMsgPack ç­‰ç­‰



## Netty é•¿è¿æ¥ã€å¿ƒè·³æœºåˆ¶äº†è§£ä¹ˆï¼Ÿ


ğŸ‘¨â€ğŸ’»**é¢è¯•å®˜** ï¼šTCP é•¿è¿æ¥å’ŒçŸ­è¿æ¥äº†è§£ä¹ˆï¼Ÿ



ğŸ™‹ **æˆ‘** ï¼šæˆ‘ä»¬çŸ¥é“ TCP åœ¨è¿›è¡Œè¯»å†™ä¹‹å‰ï¼Œserver ä¸ client ä¹‹é—´å¿…é¡»æå‰å»ºç«‹ä¸€ä¸ªè¿æ¥ã€‚å»ºç«‹è¿æ¥çš„è¿‡ç¨‹ï¼Œéœ€è¦æˆ‘ä»¬å¸¸è¯´çš„ä¸‰æ¬¡æ¡æ‰‹ï¼Œé‡Šæ”¾/å…³é—­è¿æ¥çš„è¯éœ€è¦å››æ¬¡æŒ¥æ‰‹ã€‚è¿™ä¸ªè¿‡ç¨‹æ˜¯æ¯”è¾ƒæ¶ˆè€—ç½‘ç»œèµ„æºå¹¶ä¸”æœ‰æ—¶é—´å»¶è¿Ÿçš„ã€‚



æ‰€è°“ï¼ŒçŸ­è¿æ¥è¯´çš„å°±æ˜¯ server ç«¯ ä¸ client ç«¯å»ºç«‹è¿æ¥ä¹‹åï¼Œè¯»å†™å®Œæˆä¹‹åå°±å…³é—­æ‰è¿æ¥ï¼Œå¦‚æœä¸‹ä¸€æ¬¡å†è¦äº’ç›¸å‘é€æ¶ˆæ¯ï¼Œå°±è¦é‡æ–°è¿æ¥ã€‚çŸ­è¿æ¥çš„ä¼˜ç‚¹å¾ˆæ˜æ˜¾ï¼Œå°±æ˜¯ç®¡ç†å’Œå®ç°éƒ½æ¯”è¾ƒç®€å•ï¼Œç¼ºç‚¹ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œæ¯ä¸€æ¬¡çš„è¯»å†™éƒ½è¦å»ºç«‹è¿æ¥å¿…ç„¶ä¼šå¸¦æ¥å¤§é‡ç½‘ç»œèµ„æºçš„æ¶ˆè€—ï¼Œå¹¶ä¸”è¿æ¥çš„å»ºç«‹ä¹Ÿéœ€è¦è€—è´¹æ—¶é—´ã€‚



é•¿è¿æ¥è¯´çš„å°±æ˜¯ client å‘ server åŒæ–¹å»ºç«‹è¿æ¥ä¹‹åï¼Œå³ä½¿ client ä¸ server å®Œæˆä¸€æ¬¡è¯»å†™ï¼Œå®ƒä»¬ä¹‹é—´çš„è¿æ¥å¹¶ä¸ä¼šä¸»åŠ¨å…³é—­ï¼Œåç»­çš„è¯»å†™æ“ä½œä¼šç»§ç»­ä½¿ç”¨è¿™ä¸ªè¿æ¥ã€‚é•¿è¿æ¥çš„å¯ä»¥çœå»è¾ƒå¤šçš„ TCP å»ºç«‹å’Œå…³é—­çš„æ“ä½œï¼Œé™ä½å¯¹ç½‘ç»œèµ„æºçš„ä¾èµ–ï¼ŒèŠ‚çº¦æ—¶é—´ã€‚å¯¹äºé¢‘ç¹è¯·æ±‚èµ„æºçš„å®¢æˆ·æ¥è¯´ï¼Œéå¸¸é€‚ç”¨é•¿è¿æ¥ã€‚



ğŸ‘¨â€ğŸ’»**é¢è¯•å®˜** ï¼šä¸ºä»€ä¹ˆéœ€è¦å¿ƒè·³æœºåˆ¶ï¼ŸNetty ä¸­å¿ƒè·³æœºåˆ¶äº†è§£ä¹ˆï¼Ÿ



ğŸ™‹ **æˆ‘** ï¼š



åœ¨ TCP ä¿æŒé•¿è¿æ¥çš„è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½ä¼šå‡ºç°æ–­ç½‘ç­‰ç½‘ç»œå¼‚å¸¸å‡ºç°ï¼Œå¼‚å¸¸å‘ç”Ÿçš„æ—¶å€™ï¼Œ client ä¸ server ä¹‹é—´å¦‚æœæ²¡æœ‰äº¤äº’çš„è¯ï¼Œå®ƒä»¬æ˜¯æ— æ³•å‘ç°å¯¹æ–¹å·²ç»æ‰çº¿çš„ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜, æˆ‘ä»¬å°±éœ€è¦å¼•å…¥ **å¿ƒè·³æœºåˆ¶** ã€‚



å¿ƒè·³æœºåˆ¶çš„å·¥ä½œåŸç†æ˜¯: åœ¨ client ä¸ server ä¹‹é—´åœ¨ä¸€å®šæ—¶é—´å†…æ²¡æœ‰æ•°æ®äº¤äº’æ—¶, å³å¤„äº idle çŠ¶æ€æ—¶, å®¢æˆ·ç«¯æˆ–æœåŠ¡å™¨å°±ä¼šå‘é€ä¸€ä¸ªç‰¹æ®Šçš„æ•°æ®åŒ…ç»™å¯¹æ–¹, å½“æ¥æ”¶æ–¹æ”¶åˆ°è¿™ä¸ªæ•°æ®æŠ¥æ–‡å, ä¹Ÿç«‹å³å‘é€ä¸€ä¸ªç‰¹æ®Šçš„æ•°æ®æŠ¥æ–‡, å›åº”å‘é€æ–¹, æ­¤å³ä¸€ä¸ª PING-PONG äº¤äº’ã€‚æ‰€ä»¥, å½“æŸä¸€ç«¯æ”¶åˆ°å¿ƒè·³æ¶ˆæ¯å, å°±çŸ¥é“äº†å¯¹æ–¹ä»ç„¶åœ¨çº¿, è¿™å°±ç¡®ä¿ TCP è¿æ¥çš„æœ‰æ•ˆæ€§.



TCP å®é™…ä¸Šè‡ªå¸¦çš„å°±æœ‰é•¿è¿æ¥é€‰é¡¹ï¼Œæœ¬èº«æ˜¯ä¹Ÿæœ‰å¿ƒè·³åŒ…æœºåˆ¶ï¼Œä¹Ÿå°±æ˜¯ TCP çš„é€‰é¡¹ï¼š`SO_KEEPALIVE`ã€‚ ä½†æ˜¯ï¼ŒTCP åè®®å±‚é¢çš„é•¿è¿æ¥çµæ´»æ€§ä¸å¤Ÿã€‚æ‰€ä»¥ï¼Œä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬éƒ½æ˜¯åœ¨åº”ç”¨å±‚åè®®ä¸Šå®ç°è‡ªå®šä¹‰å¿ƒè·³æœºåˆ¶çš„ï¼Œä¹Ÿå°±æ˜¯åœ¨ Netty å±‚é¢é€šè¿‡ç¼–ç å®ç°ã€‚é€šè¿‡ Netty å®ç°å¿ƒè·³æœºåˆ¶çš„è¯ï¼Œæ ¸å¿ƒç±»æ˜¯ `IdleStateHandler` ã€‚



## Netty çš„é›¶æ‹·è´äº†è§£ä¹ˆï¼Ÿ


ğŸ‘¨â€ğŸ’»**é¢è¯•å®˜** ï¼šè®²è®² Netty çš„é›¶æ‹·è´ï¼Ÿ



ğŸ™‹ **æˆ‘** ï¼š



ç»´åŸºç™¾ç§‘æ˜¯è¿™æ ·ä»‹ç»é›¶æ‹·è´çš„ï¼š



> é›¶å¤åˆ¶ï¼ˆè‹±è¯­ï¼šZero-copyï¼›ä¹Ÿè¯‘é›¶æ‹·è´ï¼‰æŠ€æœ¯æ˜¯æŒ‡è®¡ç®—æœºæ‰§è¡Œæ“ä½œæ—¶ï¼ŒCPU ä¸éœ€è¦å…ˆå°†æ•°æ®ä»æŸå¤„å†…å­˜å¤åˆ¶åˆ°å¦ä¸€ä¸ªç‰¹å®šåŒºåŸŸã€‚è¿™ç§æŠ€æœ¯é€šå¸¸ç”¨äºé€šè¿‡ç½‘ç»œä¼ è¾“æ–‡ä»¶æ—¶èŠ‚çœ CPU å‘¨æœŸå’Œå†…å­˜å¸¦å®½ã€‚
>



åœ¨ OS å±‚é¢ä¸Šçš„ `Zero-copy` é€šå¸¸æŒ‡é¿å…åœ¨ `ç”¨æˆ·æ€(User-space)` ä¸ `å†…æ ¸æ€(Kernel-space)` ä¹‹é—´æ¥å›æ‹·è´æ•°æ®ã€‚è€Œåœ¨ Netty å±‚é¢ ï¼Œé›¶æ‹·è´ä¸»è¦ä½“ç°åœ¨å¯¹äºæ•°æ®æ“ä½œçš„ä¼˜åŒ–ã€‚



Netty ä¸­çš„é›¶æ‹·è´ä½“ç°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š



1. å †å¤–å†…å­˜ï¼Œé¿å… JVM å †å†…å­˜åˆ°å †å¤–å†…å­˜çš„æ•°æ®æ‹·è´ã€‚
2. ä½¿ç”¨ Netty æä¾›çš„ `CompositeByteBuf` ç±», å¯ä»¥å°†å¤šä¸ª`ByteBuf` åˆå¹¶ä¸ºä¸€ä¸ªé€»è¾‘ä¸Šçš„ `ByteBuf`, é¿å…äº†å„ä¸ª `ByteBuf` ä¹‹é—´çš„æ‹·è´ã€‚
3. é€šè¿‡ `Unpooled.wrappedBuffer` å¯ä»¥å°† `byte` æ•°ç»„åŒ…è£…æˆ `ByteBuf` å¯¹è±¡ï¼ŒåŒ…è£…è¿‡ç¨‹ä¸­ä¸ä¼šäº§ç”Ÿå†…å­˜æ‹·è´ã€‚
4. `ByteBuf` æ”¯æŒ `slice` æ“ä½œ, å› æ­¤å¯ä»¥å°† `ByteBuf` åˆ†è§£ä¸ºå¤šä¸ªå…±äº«åŒä¸€ä¸ªå­˜å‚¨åŒºåŸŸçš„ `ByteBuf`, é¿å…äº†å†…å­˜çš„æ‹·è´ã€‚
5. é€šè¿‡ `FileRegion` åŒ…è£…çš„`FileChannel#tranferTo()` å®ç°æ–‡ä»¶ä¼ è¾“, å¯ä»¥ç›´æ¥å°†æ–‡ä»¶ç¼“å†²åŒºçš„æ•°æ®å‘é€åˆ°ç›®æ ‡ `Channel`, é¿å…äº†ä¼ ç»Ÿé€šè¿‡å¾ªç¯ `write` æ–¹å¼å¯¼è‡´çš„å†…å­˜æ‹·è´é—®é¢˜.



## å‚è€ƒ


+ netty å­¦ä¹ ç³»åˆ—äºŒï¼šNIO Reactor æ¨¡å‹ & Netty çº¿ç¨‹æ¨¡å‹ï¼š[https://www.jianshu.com/p/38b56531565d](https://www.jianshu.com/p/38b56531565d)
+ ã€ŠNetty å®æˆ˜ã€‹
+ Netty é¢è¯•é¢˜æ•´ç†(2):[https://metatronxl.github.io/2019/10/22/Netty-é¢è¯•é¢˜æ•´ç†-äºŒ/](https://metatronxl.github.io/2019/10/22/Netty-%E9%9D%A2%E8%AF%95%E9%A2%98%E6%95%B4%E7%90%86-%E4%BA%8C/)
+ Nettyï¼ˆ3ï¼‰â€”æºç  NioEventLoopGroup:[https://www.cnblogs.com/qdhxhz/p/10075568.html](https://www.cnblogs.com/qdhxhz/p/10075568.html)
+ å¯¹äº Netty ByteBuf çš„é›¶æ‹·è´(Zero Copy) çš„ç†è§£: [https://www.cnblogs.com/xys1228/p/6088805.html](https://www.cnblogs.com/xys1228/p/6088805.html)

[  
](https://www.cnblogs.com/xys1228/p/6088805.html)



> æ›´æ–°: 2023-05-15 21:39:00  
> åŸæ–‡: <https://www.yuque.com/snailclimb/mf2z3k/wlr1b0>